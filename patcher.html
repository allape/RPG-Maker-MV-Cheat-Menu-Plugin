<!DOCTYPE html>

<!-- DO NOT USE ADVANCED JS SYNTAX, KEEP IT AROUND ES5, ExceptionCaughtLocallyJS -->
<!--suppress ES6ConvertVarToLetConst, EqualityComparisonWithCoercionJS, ExceptionCaughtLocallyJS -->

<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>PRG Maker Cheat Menu Patcher</title>
</head>
<body>
<div>
	<h1>PRG Maker Cheat Menu Patcher</h1>
	<button onclick="exit()">Exit</button>
	<hr>
	<div id="Logger">
		Starting up... <br>
	</div>
</div>
<script>
	/**
	 * @typedef PluginDef
	 * @property {string} name
	 * @property {boolean} status
	 * @property {string} description
	 * @property {Object} parameters
	 */

	const EXTERNAL_PLUGIN_DEF_FILE_NAME = 'patch.json';

	/** @type PluginDef */
	const DEFAULT_PLUGIN_DEF = { name: 'AsCheater', status: true, description: '', parameters: {} };

	const MV_PLUGIN_FILE = 'www/js/plugins.js';
	const MZ_PLUGIN_FILE = 'js/plugins.js';

	/**
	 * @param {...string} msg
	 */
	function println(...msg) {
		const logger = document.getElementById('Logger');
		logger.innerHTML = logger.innerHTML + msg.join(' ') + '<br>';
	}

	function patch() {
		var fs = require('fs');
		var pluginJS = '';
		if (fs.existsSync(MV_PLUGIN_FILE)) {
			println('Found MV plugins.js file...');
			pluginJS = MV_PLUGIN_FILE;
		} else if (fs.existsSync(MZ_PLUGIN_FILE)) {
			println('Found MZ plugins.js file...');
			pluginJS = MZ_PLUGIN_FILE;
		} else {
			alert('Cannot find plugins.js file');
			exit();
			return;
		}

		/** @type PluginDef */
		var pluginDef = DEFAULT_PLUGIN_DEF;
		if (fs.existsSync(EXTERNAL_PLUGIN_DEF_FILE_NAME)) {
			println('Found external plugin definition file...');
			try {
				const patchContent = fs.readFileSync(EXTERNAL_PLUGIN_DEF_FILE_NAME, 'utf8');
				pluginDef = JSON.parse(patchContent);
				println('Use patch content:', patchContent);
			} catch (e) {
				const msg = 'Failed to parse external plugin definition file: ' + e.message;
				println(msg);
				alert(msg);
				exit();
				return;
			}
		}

		/** @type PluginDef[] */
		var plugins = [];
		const pluginJsContent = fs.readFileSync(pluginJS, 'utf8');
		try {
			plugins = new Function(pluginJsContent + '\r\n\r\nreturn $plugins;')();
			if (!(plugins instanceof Array)) {
				throw new Error('plugins.js is not valid');
			}
		} catch (e) {
			const msg = 'plugins.js is not valid, reinstall this game to restore: ' + e.message;
			println(msg);
			alert(msg);
			exit();
			return;
		}

		/** @type {'Patched' | 'Unpatched'} */
		var operation;

		const foundPlugins = plugins.filter(p => p.name == pluginDef.name);
		if (foundPlugins.length > 0) {
			println('This game has already been patched!');
			if (confirm('This game has already been patched, unpatch this game?')) {
				for (var i = 0; i < foundPlugins.length; i++) {
					plugins.splice(plugins.indexOf(foundPlugins[i]), 1);
				}
				operation = 'Unpatched';
			} else {
				exit();
				return;
			}
		} else {
			operation = 'Patched';
			plugins.push(pluginDef);
		}

		const backupFile = pluginJS + '~';
		if (!fs.existsSync(backupFile)) {
			fs.copyFileSync(pluginJS, backupFile);
		}

		var lines = [
			'// Generated by PRG Maker Cheat Menu Patcher',
			'',
			'var $plugins = ' + JSON.stringify(plugins, null, '\t') + ';',
			''
		];

		fs.writeFileSync(pluginJS, lines.join('\r\n'));

		println(operation, 'successfully!');
		setTimeout(function() {
			alert(operation + ' successfully!');
			exit();
		}, 100);
	}

	function exit() {
		if (confirm('Exit Patcher?')) {
			window.close();
		}
	}

	window.addEventListener('DOMContentLoaded', function() {
		println('Ready to patch this game in 3 seconds...');
		setTimeout(function() {
			patch();
		}, 3000);
	});
</script>
</body>
</html>
